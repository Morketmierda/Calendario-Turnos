<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de Turnos — Avanzado</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#0f1724; --card:#0b1220; --text:#e6eef8; --muted:#9aa8bf; --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
      background:var(--accent);color:white;font-weight:700;font-size:16px;
    }
    header .title{margin-left:6px}
    header .right{display:flex;gap:8px;align-items:center}

    nav{display:flex;background:transparent}
    nav button{flex:1;padding:10px;border:0;background:transparent;font-weight:700;cursor:pointer}
    nav button.active{background:var(--accent);color:white}

    main{padding:10px;max-width:1200px;margin:0 auto;}
    
    /* --- MODIFICADO: Controles de navegación del mes --- */
    .controls{display:flex;align-items:center;width:100%;margin-bottom:8px;}
    .monthLabel{font-weight:800;text-transform:uppercase;margin:0 auto;text-align:center;font-size:1.1em;}
    .view-options{margin-left:auto;white-space:nowrap;}
    
    button.icon{border:0;background:var(--card);padding:8px;border-radius:8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.06)}

    .weekdays, #calendar{display:grid;grid-template-columns:repeat(7,1fr);max-width:100%}
    .weekdays div{text-align:center;font-weight:800;padding:6px 0;font-size:12px;color:var(--muted)}
    .weekdays div:nth-child(6), .weekdays div:nth-child(7){ color:var(--danger); font-weight:900; }

    #calendar{gap:6px;margin-top:8px}
    .day{
      min-height:88px;border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:6px;
      background:var(--card);color:var(--text);position:relative;overflow:hidden;border:1px solid rgba(0,0,0,0.06);cursor:pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .day:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    .day.empty{background:transparent;border:0;min-height:40px; pointer-events: none; box-shadow: none;}
    .day-number{font-weight:800;font-size:14px}
    .shift-label{
      display:inline-block;padding:4px 6px;border-radius:8px;font-weight:700;color:white;font-size:12px;
      max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{
      background:rgba(255,255,255,0.2);padding:4px 6px;border-radius:6px;font-size:11px;font-weight:700;color:white;
    }
    .note{
      width:100%;border:0;background:transparent;color:inherit;font-size:13px;padding:4px;margin-top:auto;resize:none;
    }

    .footer-actions{display:flex;gap:8px;margin-top:12px}
    .small{font-size:13px;color:var(--muted)}

    @media (max-width:420px){
      .day{min-height:72px;padding:6px}
      header{font-size:14px}
      .monthLabel{font-size:1em;}
    }

    .modal {
      position:fixed;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.45);z-index:1000;
    }
    .modal .card{
      background:var(--card);color:var(--text);padding:16px;border-radius:12px;max-width:520px;width:92%;box-shadow:0 10px 40px rgba(0,0,0,0.4)
    }
    .modal .row{display:flex;justify-content:space-between;margin:8px 0}

    #dayActionMenu {
      position: fixed; background: var(--card); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 1001; padding: 8px; display: flex; flex-direction: column; gap: 6px; width: 200px;
    }
    #dayActionMenu .menu-title { font-weight: 800; font-size: 14px; padding: 4px 8px; margin-bottom: 4px; border-bottom: 1px solid var(--bg); }
    #dayActionMenu button {
      border: 0; background: transparent; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: left;
      display: flex; align-items: center; gap: 10px; font-weight: 600; color: var(--text); font-size: 14px;
    }
    #dayActionMenu button:hover { background: var(--bg); }
    #dayActionMenu button[data-action="close"] { margin-top: 5px; border-top: 1px solid var(--bg); }

    .pattern-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .pattern-row .day-label { width: 64px; font-weight: 700; color: var(--muted); }
    .custom-select { position: relative; flex: 1; }
    .select-selected { background-color: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; font-weight: 600; }
    .select-selected:after { position: absolute; content: ""; top: 16px; right: 12px; width: 0; height: 0; border: 6px solid transparent; border-color: var(--text) transparent transparent transparent; }
    .select-items { position: absolute; background-color: var(--card); top: 105%; left: 0; right: 0; z-index: 99; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .select-hide { display: none; }
    .select-items div { color: var(--text); padding: 10px; cursor: pointer; border-radius: 8px; }
    .select-items div:hover { background-color: var(--bg); }
    .pattern-row .custom-shift-text { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--muted); background: var(--card); }
    
    /* --- NUEVO: Selector de color --- */
    .color-picker-container { display: flex; gap: 5px; align-items: center; }
    .color-swatch { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
    .color-swatch.selected { border-color: var(--accent); transform: scale(1.1); }
    .color-swatch:hover { transform: scale(1.1); }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="left">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:34px;height:34px;border-radius:8px;background:#fff;color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800">S</div>
        <div class="title">Calendario Turnos</div>
      </div>
    </div>
    <div class="right">
      <button id="btnTheme" class="icon" title="Dark mode">🌙</button>
      <button id="btnStats" class="icon" title="Informe">📊</button>
    </div>
  </header>

  <nav>
    <button id="tabCalendar" class="active">Calendario</button>
    <button id="tabPatterns">Patrones</button>
  </nav>

  <main>
    <section id="screenCalendar" class="screen active">
      <div class="controls">
        <button id="prevBtn" class="icon">◀</button>
        <div class="monthLabel" id="monthLabel"></div>
        <button id="nextBtn" class="icon">▶</button>
        <div class="view-options">
          <label class="small" style="font-weight:700"><input id="showInitial" type="checkbox"> Mostrar solo inicial</label>
        </div>
      </div>
      <div class="weekdays"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
      <div id="calendar"></div>
      <div class="footer-actions">
        <button id="btnAddVacation" style="flex:1;padding:10px;border-radius:8px;border:0;background:var(--danger);color:white">Añadir Vacaciones</button>
        <button id="btnClearAll" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:transparent">Borrar todo</button>
      </div>
    </section>

    <section id="screenPatterns" class="screen" style="display:none">
      <div style="background:var(--card);padding:12px;border-radius:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="patternName" placeholder="Nombre patrón (opcional)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
          <input id="patternLength" type="number" min="1" max="31" value="7" style="width:90px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
          <button id="btnDefine" style="padding:8px;border-radius:8px;background:var(--accent);color:white;border:0">Definir</button>
        </div>
        <div id="patternInputs" style="margin-top:10px"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="patternStart" type="date" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
          <input id="patternRepeat" type="number" min="1" max="200" value="1" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnApply" style="flex:1;padding:10px;border-radius:8px;background:#10b981;color:white;border:0">Aplicar</button>
          <button id="btnSave" style="flex:1;padding:10px;border-radius:8px;background:#2563eb;color:white;border:0">Guardar</button>
        </div>
        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:6px">Patrones guardados</div>
          <div id="savedPatterns"></div>
        </div>
      </div>
    </section>
  </main>

  <div id="modalStats" style="display:none" class="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Informe anual</div>
        <button id="closeStats" class="icon">✖</button>
      </div>
      <div style="margin-top:12px">
        <label>Año: <input id="statsYear" type="number" style="width:120px;padding:6px;border-radius:6px;border:1px solid #e6e9ef"></label>
      </div>
      <div id="statsContent" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="dayActionMenu" style="display:none;">
    <div class="menu-title">Acciones (<span id="menuDate"></span>)</div>
    <button data-action="edit_shift">✏️ Editar Turno</button>
    <button data-action="add_overtime">➕ Horas Extra</button>
    <button data-action="add_course">🎓 Anotar Curso</button>
    <button data-action="edit_note">🗒️ Editar Nota</button>
    <button data-action="clear_day" style="color:var(--danger)">🗑️ Borrar Todo el Día</button>
    <button data-action="close">✖️ Cerrar</button>
  </div>

<script>
/* ===========================
   Estado y persistencia
   =========================== */
const STORAGE = { SHIFTS: 'cal_turnos_shifts_v3', NOTES: 'cal_turnos_notes_v3', PATTERNS: 'cal_turnos_patterns_v3', OVERTIME: 'cal_turnos_overtime_v3', COURSES: 'cal_turnos_courses_v3', VACATIONS: 'cal_turnos_vacations_v3' };
let shifts = JSON.parse(localStorage.getItem(STORAGE.SHIFTS) || '{}');
let notes = JSON.parse(localStorage.getItem(STORAGE.NOTES) || '{}');
let savedPatterns = JSON.parse(localStorage.getItem(STORAGE.PATTERNS) || '[]');
let overtime = JSON.parse(localStorage.getItem(STORAGE.OVERTIME) || '{}');
let courses = JSON.parse(localStorage.getItem(STORAGE.COURSES) || '{}');
let vacations = JSON.parse(localStorage.getItem(STORAGE.VACATIONS) || '[]');

function persistAll(){
  localStorage.setItem(STORAGE.SHIFTS, JSON.stringify(shifts)); localStorage.setItem(STORAGE.NOTES, JSON.stringify(notes)); localStorage.setItem(STORAGE.PATTERNS, JSON.stringify(savedPatterns)); localStorage.setItem(STORAGE.OVERTIME, JSON.stringify(overtime)); localStorage.setItem(STORAGE.COURSES, JSON.stringify(courses)); localStorage.setItem(STORAGE.VACATIONS, JSON.stringify(vacations));
}

/* ===========================
   Utilidades de fecha
   =========================== */
function pad(n){ return String(n).padStart(2,'0'); }
function keyFromDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function dateFromKey(k){ const [y,m,d] = k.split('-').map(Number); return new Date(y,m-1,d); }

/* ===========================
   DOM referencias
   =========================== */
const get = (id) => document.getElementById(id);
const tabCalendar = get('tabCalendar'), tabPatterns = get('tabPatterns');
const screenCalendar = get('screenCalendar'), screenPatterns = get('screenPatterns');
const monthLabel = get('monthLabel'), prevBtn = get('prevBtn'), nextBtn = get('nextBtn');
const calendarEl = get('calendar'), showInitial = get('showInitial');
const btnTheme = get('btnTheme'), btnStats = get('btnStats');
const modalStats = get('modalStats'), statsContent = get('statsContent'), statsYear = get('statsYear'), closeStats = get('closeStats');
const patternName = get('patternName'), patternLength = get('patternLength'), btnDefine = get('btnDefine');
const patternInputs = get('patternInputs'), patternStart = get('patternStart'), patternRepeat = get('patternRepeat');
const btnApply = get('btnApply'), btnSave = get('btnSave'), savedPatternsEl = get('savedPatterns');
const btnAddVacation = get('btnAddVacation'), btnClearAll = get('btnClearAll');
const dayActionMenu = get('dayActionMenu'), menuDate = get('menuDate');

/* ===========================
   Estado de vista y constantes
   =========================== */
let viewDate = new Date(); viewDate.setDate(1);
document.querySelector('body').dataset.theme = 'light';
let currentActionKey = null;
const PRESET_SHIFTS = { "Mañana": "#2563eb", "Tarde": "#f59e0b", "Noche": "#7c3aed", "Descanso": "#6b7280" };
const PREDEFINED_COLORS = ['#2563eb', '#10b981', '#f59e0b', '#7c3aed', '#ef4444', '#6b7280', '#0891b2', '#d946ef'];


/* ===========================
   Event Listeners Principales
   =========================== */
btnTheme.addEventListener('click', ()=>{
  const body = document.querySelector('body');
  body.dataset.theme = (body.dataset.theme === 'dark') ? 'light' : 'dark';
  btnTheme.textContent = body.dataset.theme === 'dark' ? '☀' : '🌙';
});
tabCalendar.addEventListener('click', ()=>{
  tabCalendar.classList.add('active'); tabPatterns.classList.remove('active');
  screenCalendar.style.display = ''; screenPatterns.style.display = 'none';
});
tabPatterns.addEventListener('click', ()=>{
  tabPatterns.classList.add('active'); tabCalendar.classList.remove('active');
  screenCalendar.style.display = 'none'; screenPatterns.style.display = '';
  renderSavedPatterns();
});

/* ===========================
   Render calendario
   =========================== */
function renderCalendar(){
  calendarEl.innerHTML = '';
  const y = viewDate.getFullYear(), m = viewDate.getMonth();
  monthLabel.textContent = viewDate.toLocaleDateString('es-ES',{month:'long',year:'numeric'});

  const last = new Date(y,m+1,0), days = last.getDate();
  let start = (new Date(y,m,1).getDay() + 6) % 7;
  for(let i=0;i<start;i++){ calendarEl.appendChild(document.createElement('div')).className='day empty'; }

  for(let d=1; d<=days; d++){
    const date = new Date(y,m,d), key = keyFromDate(date);
    const cell = document.createElement('div'); cell.className='day'; cell.dataset.key = key;

    if(shifts[key]){
      cell.style.background = shifts[key].color || '#2563eb';
      cell.style.color = luminanceFromHex(shifts[key].color || '#2563eb') < 0.5 ? '#ffffff' : '#0f172a';
    }
    
    const num = document.createElement('div'); num.className='day-number'; num.textContent = d; cell.appendChild(num);

    if(shifts[key]){
      const lbl = document.createElement('div'); lbl.className='shift-label'; lbl.textContent = showInitial.checked ? shifts[key].text.charAt(0) : shifts[key].text;
      lbl.style.background = shadeColor(shifts[key].color || '#2563eb', -10); cell.appendChild(lbl);
    }

    const badges = document.createElement('div'); badges.className='badges';
    if(overtime[key]){ const b = document.createElement('div'); b.className='badge'; b.textContent = `+${overtime[key]}h`; b.title = 'Horas extra'; badges.appendChild(b); }
    if(courses[key]?.length > 0){ courses[key].forEach(c=>{ const b = document.createElement('div'); b.className='badge'; b.textContent = `Curso ${c.hours}h`; b.title = `${c.desc || 'Curso'} ${c.start} - ${c.end}`; badges.appendChild(b); }); }
    if(isDateInAnyVacation(date)){ const b = document.createElement('div'); b.className='badge'; b.textContent = `Vacaciones`; b.title = 'Vacaciones'; badges.appendChild(b); cell.style.background = '#9ca3af'; cell.style.color = '#fff'; }
    if(badges.children.length > 0) cell.appendChild(badges);

    const ta = document.createElement('textarea'); ta.className='note'; ta.rows = 2; ta.value = notes[key] || '';
    ta.addEventListener('input', (e)=>{ notes[key] = e.target.value; persistAll(); });
    cell.appendChild(ta);

    cell.addEventListener('click', (e)=>{ e.stopPropagation(); showDayActionMenu(e, key); });
    calendarEl.appendChild(cell);
  }
}

/* ===========================
   Menú de acciones del día
   =========================== */
function showDayActionMenu(event, key){
  currentActionKey = key; menuDate.textContent = key;
  const rect = event.currentTarget.getBoundingClientRect();
  let top = rect.bottom + 8, left = rect.left;
  dayActionMenu.style.display = 'flex';
  const menuRect = dayActionMenu.getBoundingClientRect();
  if (top + menuRect.height > window.innerHeight) { top = rect.top - menuRect.height - 8; }
  if (left + menuRect.width > window.innerWidth) { left = window.innerWidth - menuRect.width - 10; }
  dayActionMenu.style.top = `${top}px`; dayActionMenu.style.left = `${left}px`;
}
function hideDayActionMenu() { dayActionMenu.style.display = 'none'; currentActionKey = null; }

dayActionMenu.addEventListener('click', (e)=>{
  const button = e.target.closest('button');
  if(!button) return;
  const action = button.dataset.action;
  
  if(action && currentActionKey){
    switch(action){
      case 'edit_shift': editShiftPrompt(currentActionKey); break;
      case 'edit_note': editNotePrompt(currentActionKey); break;
      case 'add_overtime': addOvertimePrompt(currentActionKey); break;
      case 'add_course': addCoursePrompt(currentActionKey); break;
      case 'clear_day': clearDayPrompt(currentActionKey); break;
    }
  }
  hideDayActionMenu();
});

document.addEventListener('click', (e) => {
  if (dayActionMenu.style.display === 'flex' && !dayActionMenu.contains(e.target) && !e.target.closest('.day')) {
    hideDayActionMenu();
  }
});

/* ===========================
   Navegación y Patrones
   =========================== */
prevBtn.addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); });
nextBtn.addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); });
showInitial.addEventListener('change', renderCalendar);
btnDefine.addEventListener('click', createPatternInputs);

function createPatternInputs(){
  patternInputs.innerHTML = '';
  const len = Math.max(1, Math.min(31, parseInt(patternLength.value || '1')));
  for(let i=1;i<=len;i++){
    const row = document.createElement('div'); row.className = 'pattern-row';
    let optionsHTML = Object.keys(PRESET_SHIFTS).map(s => `<div data-value="${s}" data-color="${PRESET_SHIFTS[s]}">${s}</div>`).join('') + `<div data-value="Personalizado">Personalizado...</div>`;
    let colorSwatchesHTML = PREDEFINED_COLORS.map(c => `<div class="color-swatch" data-color="${c}" style="background-color:${c};"></div>`).join('');
    
    row.innerHTML = `
      <div class="day-label">Día ${i}</div>
      <div class="custom-select">
          <div class="select-selected" data-value="Descanso">Descanso</div>
          <div class="select-items select-hide">${optionsHTML}</div>
          <input type="text" class="custom-shift-text" style="display:none;" placeholder="Turno personalizado">
      </div>
      <div class="color-picker-container">${colorSwatchesHTML}</div>
      <input type="hidden" class="color-picker-value" value="${PRESET_SHIFTS.Descanso}">
    `;
    patternInputs.appendChild(row);

    const selected = row.querySelector('.select-selected'), items = row.querySelector('.select-items');
    const customText = row.querySelector('.custom-shift-text'), colorContainer = row.querySelector('.color-picker-container');
    const colorValueInput = row.querySelector('.color-picker-value');
    
    colorContainer.querySelector(`[data-color="${PRESET_SHIFTS.Descanso}"]`)?.classList.add('selected');

    selected.addEventListener('click', () => items.classList.toggle('select-hide'));
    items.addEventListener('click', (e) => {
      const target = e.target.closest('div[data-value]'); if (!target) return;
      const value = target.dataset.value, color = target.dataset.color;
      selected.textContent = value; selected.dataset.value = value; items.classList.add('select-hide');
      
      if (value === 'Personalizado') {
        customText.style.display = 'block'; selected.style.display = 'none'; customText.focus();
      } else {
        customText.style.display = 'none'; selected.style.display = 'block';
        if (color) {
            colorValueInput.value = color;
            colorContainer.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('selected'));
            colorContainer.querySelector(`[data-color="${color}"]`)?.classList.add('selected');
        }
      }
    });

    colorContainer.addEventListener('click', (e) => {
        if(e.target.classList.contains('color-swatch')) {
            colorContainer.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('selected'));
            e.target.classList.add('selected');
            colorValueInput.value = e.target.dataset.color;
        }
    });
  }
}

btnApply.addEventListener('click', ()=>{
  const len = parseInt(patternLength.value || '0'); if(len <= 0) return;
  if(!patternStart.value){ alert('Selecciona una fecha de inicio.'); return; }
  const seq = getPatternSequence(len);
  const start = new Date(patternStart.value + 'T00:00:00');
  const reps = Math.max(1, parseInt(patternRepeat.value || '1'));
  applySavedPattern(seq, start, reps);
});

btnSave.addEventListener('click', ()=>{
  const name = patternName.value.trim() || `Patrón ${savedPatterns.length+1}`;
  const len = parseInt(patternLength.value || '0'); if(len <= 0) return;
  const seq = getPatternSequence(len);
  savedPatterns.push({name, seq}); persistAll(); renderSavedPatterns(); alert('Patrón guardado');
});

function getPatternSequence(len) {
  const seq = [];
  for(let i=0;i<len;i++){
    const row = patternInputs.children[i];
    const selected = row.querySelector('.select-selected'), customText = row.querySelector('.custom-shift-text');
    const colorValue = row.querySelector('.color-picker-value').value;
    let text = (selected.dataset.value === 'Personalizado') ? (customText.value.trim() || 'Descanso') : selected.dataset.value;
    seq.push({text: text, color: colorValue});
  }
  return seq;
}

function renderSavedPatterns(){
  savedPatternsEl.innerHTML = savedPatterns.length === 0 ? '<div class="small">Sin patrones guardados</div>' : '';
  savedPatterns.forEach((p, idx)=>{
    const row = document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:8px;background:var(--bg);border-radius:8px;';
    row.innerHTML = `
      <div><div style="font-weight:800">${p.name}</div><div class="small">${p.seq.map(s=>s.text).join(' • ')}</div></div>
      <div style="display:flex;gap:6px;">
        <button class="apply-pattern" style="padding:6px 8px;border-radius:8px;background:#10b981;color:white;border:0;cursor:pointer;">Aplicar</button>
        <button class="delete-pattern" style="padding:6px 8px;border-radius:8px;cursor:pointer;background:var(--danger);color:white;border:0;">Borrar</button>
      </div>`;
    row.querySelector('.apply-pattern').addEventListener('click', ()=>{
      const startStr = prompt('Fecha de inicio (YYYY-MM-DD)', keyFromDate(new Date())); if(!startStr) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(startStr)) { alert("Formato de fecha inválido."); return; }
      const reps = parseInt(prompt('Número de repeticiones', '1') || '1');
      if(confirm('Aplicar este patrón borrará los turnos existentes en las fechas seleccionadas. ¿Continuar?')){
        applySavedPattern(p.seq, new Date(startStr+'T00:00:00'), Math.max(1,reps));
      }
    });
    row.querySelector('.delete-pattern').addEventListener('click', ()=>{
      if(confirm(`¿Borrar el patrón "${p.name}"?`)){ savedPatterns.splice(idx,1); persistAll(); renderSavedPatterns(); }
    });
    savedPatternsEl.appendChild(row);
  });
}

function applySavedPattern(seq, startDate, reps){
  for(let r=0;r<reps;r++){
    seq.forEach((item, idx)=>{
      const d = new Date(startDate); d.setDate(startDate.getDate() + r*seq.length + idx);
      shifts[keyFromDate(d)] = {text:item.text, color:item.color};
    });
  }
  persistAll(); renderCalendar(); alert('Patrón aplicado');
}

/* ===========================
   Acciones de día (prompts)
   =========================== */
function editShiftPrompt(key){
  const cur = shifts[key] || {text:'',color:'#2563eb'};
  const txt = prompt('Turno (vacío=eliminar):', cur.text);
  if(txt === null) return;
  if(txt.trim() === ''){ delete shifts[key]; } else {
    const col = prompt('Color (hex):', cur.color) || cur.color;
    shifts[key] = {text: txt.trim(), color: col};
  }
  persistAll(); renderCalendar();
}
function editNotePrompt(key){
  const cur = notes[key] || '';
  const txt = prompt('Nota (vacío = eliminar):', cur);
  if(txt === null) return;
  if(txt.trim() === ''){ delete notes[key]; } else { notes[key] = txt.trim(); }
  persistAll(); renderCalendar();
}
function addOvertimePrompt(key){
  const cur = overtime[key] || 0;
  const val = prompt('Horas extra (número). Vacío = quitar:', String(cur));
  if(val === null) return;
  if(val.trim() === ''){ delete overtime[key]; } else {
    const num = parseFloat(val.replace(',', '.')); if(isNaN(num)){ alert('Número inválido'); return; }
    overtime[key] = num;
  }
  persistAll(); renderCalendar();
}
function addCoursePrompt(key){
  const desc = prompt('Descripción del curso:', 'Curso empresa'); if(desc === null) return;
  const start = prompt('Hora inicio (HH:MM):', '09:00'); if(start === null) return;
  const end = prompt('Hora fin (HH:MM):', '13:00'); if(end === null) return;
  const h = hoursBetween(start, end); if(h <= 0){ alert('Horas inválidas'); return; }
  const arr = courses[key] || []; arr.push({desc, start, end, hours: h});
  courses[key] = arr; persistAll(); renderCalendar();
}
function clearDayPrompt(key){
  if(confirm(`¿Borrar todos los datos del día ${key}?`)){
    delete shifts[key]; delete overtime[key]; delete courses[key]; delete notes[key];
    persistAll(); renderCalendar();
  }
}

/* ===========================
   Vacaciones y Borrar Todo
   =========================== */
btnAddVacation.addEventListener('click', ()=>{
  const from = prompt('Vacaciones DESDE (YYYY-MM-DD):'); if(!from) return;
  const to = prompt('Vacaciones HASTA (YYYY-MM-DD):'); if(!to) return;
  try {
    const start = new Date(from+'T00:00:00'), end = new Date(to+'T00:00:00');
    if(isNaN(start.getTime()) || isNaN(end.getTime()) || end < start){ alert('Fechas inválidas'); return; }
    vacations.push({from:keyFromDate(start), to:keyFromDate(end)});
    persistAll(); renderCalendar(); alert('Vacaciones añadidas');
  } catch(e) {
    alert('Error en el formato de fecha.');
  }
});
function isDateInAnyVacation(date){
  const k = keyFromDate(date); for(const v of vacations){ if(k >= v.from && k <= v.to) return true; } return false;
}
btnClearAll.addEventListener('click', ()=>{
  if(!confirm('¿Borrar TODO (turnos, notas, patrones, etc.)? Esta acción no se puede deshacer.')) return;
  shifts = {}; notes = {}; overtime = {}; courses = {}; vacations = []; savedPatterns = [];
  persistAll(); renderCalendar(); renderSavedPatterns();
});
function hoursBetween(h1, h2){
  const [hA, mA] = (h1||'0:0').split(':').map(Number); const [hB, mB] = (h2||'0:0').split(':').map(Number);
  return Math.max(0, (hB + mB/60) - (hA + mA/60));
}

/* ===========================
   Estadísticas
   =========================== */
btnStats.addEventListener('click', ()=>{
  modalStats.style.display = 'flex'; statsYear.value = new Date().getFullYear(); renderStats();
});
closeStats.addEventListener('click', ()=>{ modalStats.style.display = 'none'; });
statsYear.addEventListener('change', renderStats);

function renderStats(){
  const year = parseInt(statsYear.value || new Date().getFullYear());
  let normalHours = 0, overtimeHours = 0, courseHours = 0, vacationDays = 0;
  const map = {'Mañana':8,'Tarde':8,'Noche':8,'Descanso':0,'Vacaciones':0};
  for(const k in shifts){ if(dateFromKey(k).getFullYear() === year) normalHours += map[shifts[k].text] ?? 8; }
  for(const k in overtime){ if(dateFromKey(k).getFullYear() === year) overtimeHours += Number(overtime[k] || 0); }
  for(const k in courses){ if(dateFromKey(k).getFullYear() === year) for(const c of courses[k]) courseHours += Number(c.hours || 0); }
  for(const v of vacations){ let s = dateFromKey(v.from), e = dateFromKey(v.to); for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){ if(d.getFullYear()===year) vacationDays++; } }
  const totalWorked = normalHours + overtimeHours + courseHours;
  statsContent.innerHTML = `<div class="row"><div>Horas normales (est.):</div><b>${normalHours.toFixed(1)} h</b></div><div class="row"><div>Horas extra:</div><b>${overtimeHours.toFixed(1)} h</b></div><div class="row"><div>Horas cursos:</div><b>${courseHours.toFixed(1)} h</b></div><div class="row"><div>Días vacaciones:</div><b>${vacationDays} días</b></div><hr /><div class="row" style="font-size:1.1em"><div>Total horas aprox.:</div><b style="color:var(--accent)">${totalWorked.toFixed(1)} h</b></div>`;
}

/* ===========================
   Helpers de color
   =========================== */
function luminanceFromHex(hex){
  if(!hex) return 0; hex = hex.replace('#','');
  const r = parseInt(hex.substring(0,2),16)/255, g = parseInt(hex.substring(2,4),16)/255, b = parseInt(hex.substring(4,6),16)/255;
  const a = [r,g,b].map(v => (v <= 0.03928) ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
  return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
}
function shadeColor(hex, percent){
  const f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=Math.abs(percent)/100,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
  return `rgb(${Math.round((t-R)*p)+R},${Math.round((t-G)*p)+G},${Math.round((t-B)*p)+B})`;
}

/* ===========================
   Init
   =========================== */
(function init(){
  get('patternStart').value = (new Date()).toISOString().slice(0,10);
  createPatternInputs();
  renderSavedPatterns();
  renderCalendar();
})();

</script>
</body>
</html>

